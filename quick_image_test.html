<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>快速图像生成测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold text-center mb-6 text-red-600">🚨 快速图像生成问题诊断</h1>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">测试提示词</h2>
            <div class="space-y-4">
                <input type="text" id="prompt" placeholder="输入图像生成提示词"
                       class="w-full p-3 border rounded"
                       value="生成一只可爱的小猫，真实照片风格">
                <div class="flex gap-2">
                    <button onclick="testChinese()" class="bg-red-500 text-white px-4 py-2 rounded">测试中文</button>
                    <button onclick="testEnglish()" class="bg-blue-500 text-white px-4 py-2 rounded">测试英文</button>
                    <button onclick="testExplicit()" class="bg-green-500 text-white px-4 py-2 rounded">测试显式</button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">实时日志</h2>
            <div id="log" class="p-4 bg-black text-green-400 rounded font-mono text-sm max-h-64 overflow-auto">
                等待测试...
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-lg font-semibold mb-4">图像显示</h2>
            <div id="images" class="min-h-32 border rounded p-4">
                <span class="text-gray-500">图像将在这里显示</span>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = "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";
        const MODEL = "google/gemini-2.5-flash-image-preview";

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function testChinese() {
            testPrompt('生成一只可爱的小猫，真实照片风格', '中文');
        }

        function testEnglish() {
            testPrompt('create a cute cat, photorealistic style', '英文');
        }

        function testExplicit() {
            testPrompt('generate image: a cute cat, photorealistic style', '显式英文');
        }

        async function testPrompt(prompt, type) {
            log(`🚀 开始测试${type}提示词: "${prompt}"`);

            try {
                log('📤 发送API请求...');

                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`,
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'Quick Image Test'
                    },
                    body: JSON.stringify({
                        model: MODEL,
                        messages: [{ role: 'user', content: prompt }],
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });

                log(`📊 HTTP状态: ${response.status}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                log('📥 收到API响应');

                // 检查响应结构
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('响应格式无效');
                }

                const message = data.choices[0].message;
                log(`💬 AI回复: "${message.content}"`);

                // 检查图像数据
                if (message.images && message.images.length > 0) {
                    log(`🖼️  发现 ${message.images.length} 张图像`);

                    message.images.forEach((image, index) => {
                        log(`🖼️  图像 ${index + 1} 结构: ${JSON.stringify(image, null, 2)}`);

                        if (image.image_url && image.image_url.url) {
                            log(`🔗 图像 ${index + 1} URL: ${image.image_url.url.substring(0, 100)}...`);
                        } else {
                            log(`❌ 图像 ${index + 1} 缺少URL`);
                        }
                    });

                    displayImages(message.images);
                } else {
                    log('❌ 响应中没有图像数据');
                    log('📋 完整响应结构:');
                    log(JSON.stringify(data, null, 2));
                }

            } catch (error) {
                log(`❌ 错误: ${error.message}`);
            }
        }

        function displayImages(images) {
            const imagesDiv = document.getElementById('images');
            let html = '';

            images.forEach((image, index) => {
                if (image.image_url && image.image_url.url) {
                    html += `
                        <div class="border rounded p-4 mb-4">
                            <img src="${image.image_url.url}"
                                 alt="生成的图像 ${index + 1}"
                                 class="max-w-full h-auto rounded"
                                 onload="log('✅ 图像 ${index + 1} 加载成功')"
                                 onerror="log('❌ 图像 ${index + 1} 加载失败 - URL可能无效')">
                            <p class="text-sm text-gray-600 mt-2">图像 ${index + 1}</p>
                            <p class="text-xs text-gray-500">URL: ${image.image_url.url.substring(0, 50)}...</p>
                        </div>
                    `;
                }
            });

            imagesDiv.innerHTML = html || '<p class="text-red-500">没有图像可显示</p>';
        }
    </script>
</body>
</html>