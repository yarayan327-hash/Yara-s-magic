<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🍌 Nano Banana 图像生成测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8 text-yellow-600">🍌 Nano Banana 图像生成测试</h1>

        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <h2 class="text-lg font-semibold text-yellow-800 mb-2">📋 测试说明</h2>
            <p class="text-yellow-700">
                这个测试工具专门用于验证 <strong>Google Nano Banana (Gemini 2.5 Flash Image)</strong> 模型的图像生成功能。
                该模型支持文本到图像生成、图像编辑和多轮对话中的图像生成。
            </p>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">🔧 测试配置</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">API密钥:</label>
                    <input type="text" id="api-key" value="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"
                           class="w-full p-3 border rounded font-mono text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Nano Banana模型ID:</label>
                    <input type="text" id="model-id" value="google/gemini-2.5-flash-preview-image"
                           class="w-full p-3 border rounded font-mono text-sm bg-gray-100" readonly>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">🎯 测试提示词</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">自定义提示词:</label>
                    <input type="text" id="custom-prompt" placeholder="描述您想要生成的图像"
                           class="w-full p-3 border rounded">
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <button onclick="testPrompt('一只可爱的小猫，真实照片风格')"
                            class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">可爱小猫</button>
                    <button onclick="testPrompt('generate image: a cute cat, photorealistic style')"
                            class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">Cute Cat</button>
                    <button onclick="testPrompt('生成图像：未来城市的日落景象，赛博朋克风格')"
                            class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">未来城市</button>
                    <button onclick="testPrompt('create an image: a peaceful mountain landscape at sunrise')"
                            class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Mountain Sunrise</button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">📊 实时日志</h2>
            <div id="log" class="p-4 bg-black text-green-400 rounded font-mono text-sm max-h-64 overflow-auto">
                等待测试Nano Banana...
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">🖼️ 图像显示</h2>
            <div id="images" class="min-h-32 border rounded p-4 flex items-center justify-center">
                <span class="text-gray-500">Nano Banana生成的图像将在这里显示</span>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = document.getElementById('api-key').value;
        const MODEL_ID = document.getElementById('model-id').value;

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function testPrompt(promptText) {
            document.getElementById('custom-prompt').value = promptText;
            testNanoBanana();
        }

        async function testNanoBanana() {
            const prompt = document.getElementById('custom-prompt').value;

            if (!prompt) {
                alert('请输入提示词');
                return;
            }

            log(`🚀 开始测试Nano Banana图像生成`);
            log(`📝 提示词: "${prompt}"`);
            log(`🤖 模型: ${MODEL_ID}`);

            try {
                log('📡 连接到OpenRouter API...');

                // 🔍 使用正确的Nano Banana格式 - 根据Google文档
                const requestBody = {
                    model: MODEL_ID,
                    messages: [
                        {
                            role: 'user',
                            content: [
                                {
                                    type: 'text',
                                    text: prompt
                                }
                            ]
                        }
                    ],
                    temperature: 0.7,
                    max_tokens: 1000,
                    // 添加图像生成参数
                    modalities: ["text", "image"],
                    response_format: { type: "text" }
                };

                log('📋 请求体: ' + JSON.stringify(requestBody, null, 2));

                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`,
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'Nano Banana Test'
                    },
                    body: JSON.stringify(requestBody)
                });

                log(`📊 HTTP状态: ${response.status}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                log('📥 收到API响应');

                // 🔍 详细分析响应结构
                log('🔍 分析响应结构...');
                log('📋 完整响应: ' + JSON.stringify(data, null, 2));

                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('响应格式无效：缺少message字段');
                }

                const message = data.choices[0].message;
                log(`💬 AI回复: "${message.content}"`);

                // 🔍 检查图像数据
                log(`🔍 检查图像数据...`);
                log(`📊 是否有images字段: ${message.images ? '是' : '否'}`);

                if (message.images && message.images.length > 0) {
                    log(`🎉 发现 ${message.images.length} 张图像！`);

                    message.images.forEach((image, index) => {
                        log(`🖼️  图像 ${index + 1} 详情:`);
                        log(`   类型: ${image.type}`);
                        log(`   是否有image_url: ${image.image_url ? '是' : '否'}`);

                        if (image.image_url && image.image_url.url) {
                            log(`   URL长度: ${image.image_url.url.length} 字符`);
                            log(`   URL预览: ${image.image_url.url.substring(0, 100)}...`);
                        }
                    });

                    displayImages(message.images);
                } else {
                    log('❌ 响应中没有图像数据');
                    log('💡 可能的原因:');
                    log('   1. 模型不支持图像生成');
                    log('   2. 提示词没有触发图像生成功能');
                    log('   3. API密钥权限不足');
                    log('   4. 需要特定的提示词格式');

                    // 显示完整响应以供分析
                    log('📊 完整响应结构分析:');
                    analyzeResponseStructure(data);
                }

            } catch (error) {
                log(`❌ 错误: ${error.message}`);
                document.getElementById('images').innerHTML = `
                    <div class="text-red-500">
                        <p class="font-semibold">错误: ${error.message}</p>
                        <p class="text-sm mt-2">请检查API密钥和网络连接</p>
                    </div>
                `;
            }
        }

        function analyzeResponseStructure(data) {
            log('🔬 详细响应结构分析:');

            try {
                // 检查响应的每个部分
                log(`📍 响应键: ${Object.keys(data).join(', ')}`);

                if (data.choices) {
                    log(`📍 choices数量: ${data.choices.length}`);

                    data.choices.forEach((choice, index) => {
                        log(`📍 choice[${index}] 键: ${Object.keys(choice).join(', ')}`);

                        if (choice.message) {
                            log(`📍 message 键: ${Object.keys(choice.message).join(', ')}`);

                            if (choice.message.content) {
                                log(`📍 内容长度: ${choice.message.content.length}`);
                            }

                            if (choice.message.images) {
                                log(`📍 图像数量: ${choice.message.images.length}`);
                            } else {
                                log('📍 无images字段');
                            }
                        }
                    });
                }

                // 检查是否有错误信息
                if (data.error) {
                    log(`🚨 API错误: ${JSON.stringify(data.error)}`);
                }

                // 检查使用统计
                if (data.usage) {
                    log(`📈 使用统计: ${JSON.stringify(data.usage)}`);
                }

            } catch (e) {
                log(`🔍 分析错误: ${e.message}`);
            }
        }

        function displayImages(images) {
            const imagesDiv = document.getElementById('images');
            let html = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <h3 class="md:col-span-2 text-lg font-semibold text-green-600 mb-4">✅ Nano Banana成功生成图像！</h3>
            `;

            images.forEach((image, index) => {
                if (image.image_url && image.image_url.url) {
                    html += `
                        <div class="border rounded-lg p-4">
                            <img src="${image.image_url.url}"
                                 alt="Nano Banana生成的图像 ${index + 1}"
                                 class="max-w-full h-auto rounded cursor-pointer hover:opacity-80"
                                 onclick="window.open('${image.image_url.url}', '_blank')"
                                 onload="log('✅ 图像 ${index + 1} 加载成功')"
                                 onerror="log('❌ 图像 ${index + 1} 加载失败')">
                            <p class="text-sm text-gray-600 mt-2">图像 ${index + 1}</p>
                            <p class="text-xs text-gray-500 mt-1">URL: ${image.image_url.url.substring(0, 50)}...</p>
                        </div>
                    `;
                }
            });

            html += '</div>';
            imagesDiv.innerHTML = html;

            log('🎉 图像显示完成！点击图像可查看完整尺寸');
        }

        // 页面加载时自动运行一次测试
        window.addEventListener('load', () => {
            log('🍌 Nano Banana测试工具已加载');
            log('📋 模型ID: ' + MODEL_ID);
            log('🔧 准备开始测试...');
        });
    </script>
</body>
</html>