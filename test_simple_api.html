<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简化API测试 - Nano Banana</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold text-center mb-6 text-blue-600">🔧 简化API测试工具</h1>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">测试配置</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">API密钥:</label>
                    <input type="text" id="api-key" value="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"
                           class="w-full p-3 border rounded font-mono text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">模型:</label>
                    <select id="model" class="w-full p-3 border rounded">
                        <option value="google/gemini-2.5-flash-preview-image">🍌 Nano Banana (Gemini 2.5 Flash Image)</option>
                        <option value="google/gemini-flash-1.5">Gemini Flash 1.5</option>
                        <option value="openai/dall-e-3">DALL-E 3</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">测试提示词</h2>
            <div class="space-y-4">
                <input type="text" id="prompt" placeholder="输入测试提示词"
                       class="w-full p-3 border rounded" value="一只可爱的小猫">
                <div class="flex gap-2">
                    <button onclick="testBasic()" class="bg-blue-500 text-white px-4 py-2 rounded">基础测试</button>
                    <button onclick="testWithImageKeyword()" class="bg-green-500 text-white px-4 py-2 rounded">含图像关键词</button>
                    <button onclick="testEnglish()" class="bg-purple-500 text-white px-4 py-2 rounded">英文测试</button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-lg font-semibold mb-4">请求详情</h2>
                <div id="request-details" class="p-4 bg-gray-100 rounded font-mono text-xs max-h-48 overflow-auto">
                    等待测试...
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-lg font-semibold mb-4">响应详情</h2>
                <div id="response-details" class="p-4 bg-gray-100 rounded font-mono text-xs max-h-48 overflow-auto">
                    等待响应...
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
            <h2 class="text-lg font-semibold mb-4">测试结果</h2>
            <div id="test-results" class="p-4 border rounded min-h-32">
                <span class="text-gray-500">测试结果将在这里显示</span>
            </div>
        </div>
    </div>

    <script>
        function testBasic() {
            testAPI('一只可爱的小猫');
        }

        function testWithImageKeyword() {
            testAPI('生成图像：一只可爱的小猫，真实照片风格');
        }

        function testEnglish() {
            testAPI('generate image: a cute cat, photorealistic style');
        }

        async function testAPI(prompt) {
            const apiKey = document.getElementById('api-key').value;
            const model = document.getElementById('model').value;

            // 显示请求详情
            const requestBody = {
                model: model,
                messages: [{
                    role: 'user',
                    content: prompt
                }],
                temperature: 0.7,
                max_tokens: 1000
            };

            document.getElementById('request-details').innerHTML = `
                <div class="text-sm">
                    <strong>模型:</strong> ${model}<br>
                    <strong>提示词:</strong> ${prompt}<br>
                    <strong>完整请求:</strong><br>
                    <pre class="mt-2 text-xs">${JSON.stringify(requestBody, null, 2)}</pre>
                </div>
            `;

            document.getElementById('response-details').innerHTML = '等待响应...';
            document.getElementById('test-results').innerHTML = '测试中...';

            try {
                console.log('🚀 开始API测试');
                console.log('📋 请求数据:', requestBody);

                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'Simple API Test'
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('📊 响应状态:', response.status);
                console.log('📊 响应头:', Object.fromEntries(response.headers.entries()));

                if (!response.ok) {
                    const errorText = await response.text();
                    console.log('❌ 错误响应:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('📥 完整响应:', JSON.stringify(data, null, 2));

                // 显示响应详情
                document.getElementById('response-details').innerHTML = `
                    <div class="text-sm">
                        <strong>HTTP状态:</strong> ${response.status}<br>
                        <strong>完整响应:</strong><br>
                        <pre class="mt-2 text-xs">${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;

                // 分析响应
                analyzeResponse(data, prompt);

            } catch (error) {
                console.error('❌ 测试错误:', error);

                document.getElementById('response-details').innerHTML = `
                    <div class="text-red-600">
                        <strong>错误:</strong> ${error.message}<br>
                        <strong>建议:</strong> 检查API密钥和网络连接
                    </div>
                `;

                document.getElementById('test-results').innerHTML = `
                    <div class="text-red-500">
                        <p class="font-semibold">测试失败</p>
                        <p class="text-sm">${error.message}</p>
                    </div>
                `;
            }
        }

        function analyzeResponse(data, originalPrompt) {
            const resultsDiv = document.getElementById('test-results');

            try {
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    resultsDiv.innerHTML = `
                        <div class="text-red-500">
                            <p class="font-semibold">响应格式无效</p>
                            <p class="text-sm">缺少message字段</p>
                        </div>
                    `;
                    return;
                }

                const message = data.choices[0].message;
                const hasImages = message.images && message.images.length > 0;

                let html = `
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold ${hasImages ? 'text-green-600' : 'text-orange-600'}">
                            ${hasImages ? '✅' : '⚠️'} 测试结果
                        </h3>

                        <div>
                            <h4 class="font-medium">AI回复:</h4>
                            <p class="text-sm bg-gray-100 p-3 rounded">${message.content}</p>
                        </div>
                `;

                if (hasImages) {
                    html += `
                        <div>
                            <h4 class="font-medium text-green-600">🎉 图像生成成功！</h4>
                            <p class="text-sm">生成了 ${message.images.length} 张图像</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"
                    `;

                    message.images.forEach((image, index) => {
                        if (image.image_url && image.image_url.url) {
                            html += `
                                <div class="border rounded p-2">
                                    <img src="${image.image_url.url}" alt="图像 ${index + 1}" class="max-w-full h-auto rounded">
                                    <p class="text-xs text-gray-500 mt-1">图像 ${index + 1}</p>
                                </div>
                            `;
                        }
                    });

                    html += '</div></div>';
                } else {
                    html += `
                        <div class="bg-yellow-50 border border-yellow-200 rounded p-4">
                            <h4 class="font-medium text-yellow-800">⚠️ 无图像生成</h4>
                            <p class="text-sm text-yellow-700">此模型可能不支持图像生成，或提示词未触发图像功能</p>
                            <p class="text-xs text-yellow-600 mt-2">原始提示词: "${originalPrompt}"</p>
                        </div>
                    `;
                }

                html += '</div>';
                resultsDiv.innerHTML = html;

            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="text-red-500">
                        <p class="font-semibold">分析错误</p>
                        <p class="text-sm">${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>